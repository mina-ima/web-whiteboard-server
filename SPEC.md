### Web Whiteboard Signaling Server: Developer Specification

このドキュメントは、Cloudflare WorkersとDurable Objects上に構築されたリアルタイム・ホワイトボード・シグナリングサーバーの技術仕様を定義します。

---

#### 1. 概要

本システムは、Y.jsライブラリを使用したリアルタイムの共同編集ホワイトボードアプリケーションのためのシグナリングサーバーです。Cloudflare Workerをエントリーポイントとし、各ホワイトボードルームの状態をDurable Objectで管理します。これにより、スケーラブルで低遅延なセッション管理を実現します。

#### 2. アーキテクチャ

*   **Cloudflare Worker (`worker.js`)**:
    *   すべてのHTTPリクエストの受付窓口。
    *   リクエストURLから`room`名を抽出（`?room=...` または `/websocket/<room>`）し、適切なDurable Objectインスタンスへリクエストを転送します。
    *   WebSocket以外のリクエストは `200 OK` を返します（ヘルスチェック用途）。
    *   `/ai/brainstorm` と `/ai/analyze` のHTTP POSTを受け取り、Gemini API へのプロキシとして動作します。

*   **Durable Object (`WhiteboardRoom`)**:
    *   各ルーム（例：`room=my-room-1`）ごとにユニークなインスタンスが生成されるステートフルなオブジェクトです。
    *   主な責務：
        1.  **認証**: ルームへのアクセスをパスワードで制御します。
        2.  **WebSocketセッション管理**: ルームに参加している全クライアントのWebSocket接続を管理します。
        3.  **Y.jsドキュメント同期**: ルームの中央Y.jsドキュメント (`Y.Doc`) を保持し、クライアントからの更新を他の全クライアントにブロードキャストします。
        4.  **永続化**: Y.jsドキュメントの状態とルームのパスワードを永続ストレージに保存します。

#### 3. 認証とパスワード管理フロー

パスワードはルームごとに動的に設定されます。ハードコードされたパスワードは存在しません。

##### 3.1. ルームの新規作成と最初のユーザーの接続

1.  **接続試行**: クライアントが任意のパスワードを指定して、新しいルームに接続します。
    ```
    wss://<your-worker-url>/websocket?room=new-room-a&passcode=user-secret-123
    wss://<your-worker-url>/websocket/new-room-a?passcode=user-secret-123
    ```
2.  **インスタンス起動**: `new-room-a`に対応する`WhiteboardRoom`インスタンスが起動します。
3.  **パスワード確認**: インスタンスは自身の永続ストレージ内に`passcode`が存在するか確認します。
4.  **パスワード設定**:
    *   `passcode`が存在しない場合（ルームが新規であるか、以前にリセットされている）、クライアントが指定した`user-secret-123`がこのルームのパスワードとして採用されます。
    *   採用されたパスワードは、インスタンスのメモリ (`this.passcode`) と永続ストレージ (`this.state.storage`) の両方に保存されます。
5.  **接続成功**: WebSocket接続が確立されます。

##### 3.2. 既存ルームへの後続ユーザーの接続

1.  **接続試行**: 別のクライアントが、既にアクティブな`new-room-a`に接続します。
2.  **パスワード検証**: `WhiteboardRoom`インスタンスは、保持しているパスワード (`user-secret-123`) と、今回リクエストされたパスワードを比較します。
3.  **判定**:
    *   **一致**: パスワードが一致すれば、WebSocket接続が確立されます。
    *   **不一致**: パスワードが一致しない場合、サーバーはクライアントに **`HTTP 401 Authentication failed`** を返し、接続を拒否します。これが、`1234`で作成したルームに他のパスワードで入れない理由です。

##### 3.3. ルームのリセット

1.  **クライアント切断**: クライアントがWebSocket接続を閉じます。
2.  **セッション数確認**: サーバーは、接続が切断されるたびに、現在のルーム内のアクティブなセッション数をチェックします。
3.  **パスワード削除**:
    *   最後のクライアントが切断し、アクティブなセッション数が`0`になった時点で、サーバーは永続ストレージとメモリから`passcode`を削除します。
    *   これにより、ルームは完全にリセットされ、次に接続するユーザーが新しいパスワードを自由に設定できる状態に戻ります。

#### 4. データフロー (Y.js)

1.  クライアントAがローカルでコンテンツを編集し、Y.jsの`update`メッセージを生成します。
2.  クライアントAはWebSocket経由で`update`メッセージをサーバーに送信します。
3.  `WhiteboardRoom`インスタンスは受信した`update`を中央の`Y.Doc`に適用します。
4.  `Y.Doc`の変更をトリガーに、更新された`update`メッセージが生成されます。
5.  サーバーは、クライアントAを含む、ルーム内の**すべての**接続中クライアントにこの`update`メッセージをブロードキャストします。
6.  各クライアントは受信した`update`を自身のY.jsドキュメントに適用し、全クライアントの表示が同期されます。

#### 5. エラーハンドリング戦略

サーバーは以下のHTTPステータスコードを返します。

*   `400 Bad Request`: URLクエリとパスのいずれにも`room`が含まれていない場合。
*   `401 Unauthorized`: 既存ルームへの接続時に`passcode`が間違っている場合。
*   `426 Upgrade Required`: リクエストヘッダーがWebSocketへのアップグレードを示していない場合。
*   `200 OK`: WebSocket以外の通常HTTPリクエスト（ヘルスチェック等）。
*   `500 Internal Server Error`: Gemini API キーが未設定、またはAIプロキシ内部エラー。

#### 7. AI プロキシ (任意機能)

AI機能はクライアントから直接APIキーを扱わないため、Worker側でGemini APIへのプロキシを提供します。

* **環境変数**: `GEMINI_API_KEY`
* **エンドポイント**:
  * `POST /ai/brainstorm` - body: `{ "topic": "..." }` -> response: `{ "ideas": string[] }`
  * `POST /ai/analyze` - body: `{ "imageData": "data:image/png;base64,..." }` -> response: `{ "text": string }`

#### 6. テスト計画

このシステムの動作を検証するには、以下のシナリオをテストします。

1.  **テストケース1: 新規ルーム作成**
    *   **手順**: 新しいルーム名 (`test-room-1`) と任意のパスワード (`pass1`) で接続する。
    *   **期待値**: 接続が成功する。

2.  **テストケース2: 既存ルームへの正常接続**
    *   **手順**: `test-room-1`に、同じパスワード (`pass1`) で別のクライアントから接続する。
    *   **期待値**: 接続が成功する。

3.  **テストケース3: 既存ルームへの不正接続**
    *   **手順**: `test-room-1`に、**間違った**パスワード (`wrong-pass`) で接続する。
    *   **期待値**: 接続が`401`エラーで拒否される。

4.  **テストケース4: ルームのリセットと再利用**
    *   **手順1**: `test-room-1`からすべてのクライアントを切断する。
    *   **手順2**: `test-room-1`に、**新しい**パスワード (`pass2`) で接続する。
    *   **期待値**: 接続が成功し、ルームのパスワードが`pass2`に設定される。

5.  **テストケース5: 複数ルームの並行動作**
    *   **手順**: `test-room-2`にパスワード`pass-abc`で接続し、同時に`test-room-3`にパスワード`pass-xyz`で接続する。
    *   **期待値**: 両方の接続が成功し、それぞれのルームが独立して機能する。

この仕様書が現在の実装の理解に役立つことを願っています。もし挙動の変更をご希望の場合は、この仕様書を基にご指示ください。
